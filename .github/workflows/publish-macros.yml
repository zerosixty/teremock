name: Publish Macros to crates.io

on:
  push:
    tags:
      - 'teremock_macros/v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish Macros
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Verify tag matches Cargo.toml version
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/teremock_macros/v}"
          CARGO_VERSION=$(grep '^version' teremock_macros/Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')

          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "Error: Tag version ($TAG_VERSION) doesn't match Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi

          echo "Version verified: $TAG_VERSION"

      - name: Publish teremock_macros
        run: cargo publish -p teremock_macros --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Verify publish
        run: |
          VERSION=$(grep '^version' teremock_macros/Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Waiting for teremock_macros $VERSION to be indexed..."

          for i in {1..20}; do
            sleep 15
            if curl -sf "https://crates.io/api/v1/crates/teremock_macros/$VERSION" | grep -q '"version"'; then
              echo "teremock_macros $VERSION successfully published!"
              exit 0
            fi
            echo "Waiting for crates.io indexing... (attempt $i/20)"
          done

          echo "Warning: Could not verify publish, but it may still succeed"
